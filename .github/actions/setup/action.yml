name: "Set up repository for CI"
description: "Install development dependencies"

inputs:
    python-version:
        description: "Python version to install"
        default: "3.11"
    poetry-version:
        description: "Poetry version to install"
        default: "1.3.2"
    cache:
        description: "Cache directory"
        default: "${{ runner.temp }}/cache"

runs:
    using: "composite"
    steps:
        - name: "Set up Python"
          id: setup-python
          uses: actions/setup-python@v4
          with:
              python-version: ${{ inputs.python-version }}

        - name: "Set up dependency cache"
          uses: actions/cache@v3
          with:
              key: ${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ inputs.poetry-version }}-${{ hashFiles('poetry.lock') }}
              path: ${{ inputs.cache }}

        - name: "Set up PATH on POSIX"
          if: ${{ runner.os != 'windows'}}
          shell: bash
          run: echo "${{ inputs.cache }}/tools/bin" >> $GITHUB_PATH

        - name: "Set up PATH on Windows"
          if: ${{ runner.os == 'windows'}}
          shell: bash
          run: echo "${{ inputs.cache }}/tools/Scripts" >> $GITHUB_PATH

        - name: "Check poetry installation"
          id: check-poetry
          shell: bash
          continue-on-error: true
          run: poetry --version

        - name: "Install poetry"
          shell: bash
          if: ${{ steps.check-poetry.outcome == 'failure'}}
          run: |
              "${{ steps.setup-python.outputs.python-path }}" -m venv "${{ inputs.cache }}/tools"
              pip install poetry==${{ inputs.poetry-version }}
              which pip
              which poetry

        - name: "Install development dependencies"
          shell: bash
          run: |
              poetry config cache-dir "${{ inputs.cache }}/poetry"
              poetry install --sync
